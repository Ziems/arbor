FROM nvidia/cuda:12.8.1-cudnn-runtime-ubuntu22.04
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    python3 \
    python3-dev \
    python3-pip \
    python3-venv \
    git \
    curl \
    build-essential \
    htop \
    vim \
    nano \
    tree \
    jq \
    && rm -rf /var/lib/apt/lists/*

RUN update-alternatives --install /usr/bin/python python /usr/bin/python3 1

WORKDIR /workspace

RUN mkdir -p /workspace/projects /workspace/data /workspace/models /workspace/repos

RUN uv venv /workspace/.venv/
ENV PATH="/workspace/.venv/bin:$PATH"
ENV VIRTUAL_ENV="/workspace/.venv"

RUN uv pip install \
    pandas \
    numpy \
    requests \
    tqdm

RUN uv pip install -U dspy
RUN uv pip install -U arbor-ai

# Note: Source repositories can be cloned at runtime with:
# git clone https://github.com/stanfordnlp/dspy.git /workspace/repos/dspy
# git clone https://github.com/Ziems/arbor.git /workspace/repos/arbor

# Setup Shell environment
RUN echo 'alias ll="ls -la"' >> /root/.bashrc && \
    echo 'export PATH="/workspace/repos/dspy:/workspace/repos/arbor:$PATH"' >> /root/.bashrc && \
    echo 'cd /workspace' >> /root/.bashrc

# Set up shell environment
RUN echo "alias l='ls -la'" >> /root/.bashrc && \
    echo "alias la='ls -la'" >> /root/.bashrc && \
    echo "export PATH=/workspace/repos/arborPATH:/root/.local/bin:$PATH" >> /root/.bashrc && \
    echo "cd /workspace" >> /root/.bashrc

# Create a script for development environment setup
RUN echo "#!/bin/bash" > /workspace/dev-setup.sh && \
    echo "echo 'Development Environment Setup...'" >> /workspace/dev-setup.sh && \
    echo "echo 'Available packages:'" >> /workspace/dev-setup.sh && \
    echo "  ls /workspace/dev-setup.sh" >> /workspace/dev-setup.sh && \
    echo "  [ -f /import/arbor/printable_version ] && /dev/null || echo '[not found]'" >> /workspace/dev-setup.sh && \
    echo "  [ -f /import/setup/dev-setup.sh ] && source /workspace/dev-setup.sh || echo '[not found]'" >> /workspace/dev-setup.sh && \
    echo "  [ -f /workspace/project_data ] && echo 'Data files and datasets...' || echo '[not found]'" >> /workspace/dev-setup.sh && \
    echo "  [ -f /workspace/models ] && echo 'Model files and datasets...' || echo '[not found]'" >> /workspace/dev-setup.sh && \
    echo "  [ -f /workspace/repos ] && echo 'Source code repositories...' || echo '[not found]'" >> /workspace/dev-setup.sh && \
    echo "  [ -f /workspace/dev-setup.sh ] && echo 'Install local editable versions:'" >> /workspace/dev-setup.sh && \
    echo "    uw pip install -e /workspace/repos/dsp/" >> /workspace/dev-setup.sh && \
    echo "    uw pip install -e /workspace/repos/arbor/" >> /workspace/dev-setup.sh && \
    echo "'happy coding!'" >> /workspace/dev-setup.sh

RUN chmod +x /workspace/dev-setup.sh

# Expose common ports
EXPOSE 8080 7433 8000

# Set default working directory
WORKDIR /workspace

# Default to bash shell for interactive development
CMD ["/bin/bash", "-c", "/workspace/dev-setup.sh && /bin/bash"]
